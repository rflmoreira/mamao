<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-g">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>+5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            padding-bottom: 100px; /* Espaço para o rodapé fixo */
        }
        /* Barra de rolagem personalizada */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #f97316; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #fb923c; }
        
        /* Animações */
        .workout-list-enter { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1.5);
                box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7);
            }
            50% {
                transform: scale(1.6);
                box-shadow: 0 0 0 6px rgba(249, 115, 22, 0);
            }
        }
        .current-week-marker-animation {
            animation: pulse 2s infinite;
        }

        .progress-bar-striped {
            background-image: repeating-linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.2) 0,
                rgba(255, 255, 255, 0.2) 10px,
                transparent 10px,
                transparent 20px
            );
            background-size: 28px 28px;
            animation: stripe-animation 1s linear infinite;
        }

        @keyframes stripe-animation {
            from { background-position: 0 0; }
            to { background-position: 28px 0; }
        }
        
        /* Tooltip personalizado */
        .step-tooltip { visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        .group:hover .step-tooltip { visibility: visible; opacity: 1; }
        
        /* Estilo do exercício completo */
        .exercise-completed {
            opacity: 0.6;
            background-color: #1f2937;
        }
        .exercise-completed h3 {
            text-decoration: line-through;
        }

        /* Estilos para o novo check animado */
        .animated-check-container {
            width: 32px;
            height: 32px;
            cursor: pointer;
        }

        .animated-check-svg {
            width: 100%;
            height: 100%;
        }

        .animated-check-circle {
            stroke: #4b5563; /* gray-600 */
            stroke-width: 3;
            fill: rgba(75, 85, 99, 0.2); /* bg-gray-600 com opacidade */
            transition: stroke 0.4s ease, fill 0.4s ease;
        }

        .animated-check-path {
            stroke: #ffffff;
            stroke-width: 4;
            stroke-linecap: round;
            stroke-linejoin: round;
            fill: none;
            stroke-dasharray: 24;
            stroke-dashoffset: 24;
            transition: stroke-dashoffset 0.4s 0.1s ease-in-out;
        }

        .animated-check-container.completed .animated-check-circle {
            stroke: #16a34a; /* green-600 */
            fill: rgba(22, 163, 74, 0.2); /* bg-green-600 com opacidade */
        }

        .animated-check-container.completed .animated-check-path {
            stroke-dashoffset: 0;
        }
        
        /* Melhorias no stepper mobile */
        @media (max-width: 768px) {
            #stepper-nav {
                overflow-x: hidden;
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            .step-tooltip {
                font-size: 9px;
                padding: 1px 4px;
                margin-bottom: 4px;
            }
            
            /* Otimização do seletor de dias para mobile */
            #day-selector {
                padding: 0.375rem;
                gap: 0.125rem;
            }
            
            #day-selector button {
                font-size: 11px;
                padding: 0.375rem 0.25rem;
                min-width: calc((100% - 6 * 0.125rem) / 7);
                max-width: calc((100% - 6 * 0.125rem) / 7);
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="main-content" class="container mx-auto p-4 md:p-6 max-w-4xl transition-all duration-500">

        <!-- Cabeçalho -->
        <header class="text-center mb-10">
            <div class="flex justify-center items-center h-32">
                <img src="imagens\HypeFit.png" 
                     alt="HyperFit Logo" 
                     class="h-24 md:h-32 w-auto drop-shadow-lg">
            </div>
        </header>

        <!-- Cabeçalho da Fase -->
        <div id="phase-header" class="text-center mb-6">
            <!-- Título da fase e progresso da semana serão inseridos aqui -->
        </div>

        <!-- Navegação das Semanas/Níveis -->
        <div class="bg-gray-800 p-2 rounded-lg mb-8">
            <div id="stepper-nav" class="py-2 overflow-hidden">
                <!-- Stepper compacto será inserido aqui pelo JS -->
            </div>
        </div>

        <!-- Seletor de Dia/Treino -->
        <div id="day-selector" class="flex justify-center gap-1 md:gap-2 mb-8 bg-gray-800 p-2 rounded-lg overflow-hidden">
             <!-- Abas dos dias serão inseridas aqui pelo JS -->
        </div>
        
        <!-- Container do Treino Atual -->
        <div id="current-workout-container" class="workout-list-enter">
            <div id="workout-title" class="text-center mb-4 min-h-[32px]"></div>
            <div id="progress-bar-container" class="mb-6 px-2"></div>
            <main id="workout-details" class="space-y-4">
                <!-- Lista de exercícios será inserida aqui pelo JS -->
            </main>
        </div>
    </div>

    <!-- Botão Fixo do Rodapé -->
    <footer id="footer-container" class="fixed bottom-0 left-0 right-0 p-4 z-40">
        <div class="container mx-auto max-w-4xl">
            <button id="complete-workout-btn" class="w-full bg-green-600/80 backdrop-blur-sm text-white font-bold py-3 px-6 rounded-3xl text-lg hover:bg-green-500 disabled:bg-gray-600/80 disabled:backdrop-blur-sm disabled:cursor-not-allowed flex items-center justify-center gap-2 shadow-2xl shadow-black/50">
                 <i class='ph-bold ph-checks text-2xl'></i>
                Concluir Treino
            </button>
        </div>
    </footer>
    
    <canvas id="confetti-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-[100]"></canvas>

    <!-- Botão Flutuante de Música -->
    <button id="open-player-btn" class="fixed top-1/2 right-0 -translate-y-1/2 mr-4 md:mr-6 bg-orange-600/80 backdrop-blur-sm text-white w-16 h-16 rounded-full shadow-2xl hover:bg-orange-500 z-40 flex items-center justify-center cursor-grab active:cursor-grabbing">
        <i class='ph-fill ph-music-notes-simple text-2xl'></i>
    </button>
    
    <!-- Modal do Player de Música -->
    <div id="player-modal" class="fixed inset-0 bg-black/60 backdrop-blur-md z-50 flex items-center justify-center p-4 opacity-0 invisible transition-opacity duration-500">
        <!-- Card do Player -->
        <div id="player-card" class="w-full max-w-sm bg-gray-800/50 border border-white/10 backdrop-blur-xl rounded-2xl shadow-2xl p-6 transform scale-95 transition-all duration-500 relative">
            <!-- Capa do Álbum -->
            <img id="album-art" src="imagens/EDM.png" alt="Capa do Álbum" class="w-full rounded-lg shadow-lg aspect-square">

            <!-- Informações da Música -->
            <div class="text-center mt-6">
                <h2 id="song-title" class="text-2xl font-bold">EDM</h2>
                <p id="song-artist" class="text-md text-white/60 mt-1">Sunshine-Live.de</p>
            </div>

            <!-- Controles de Reprodução -->
            <div class="flex items-center justify-center gap-6 mt-8">
                <button id="play-pause-btn" class="bg-orange-600/80 backdrop-blur-sm text-white w-16 h-16 rounded-full shadow-2xl hover:bg-orange-500 flex items-center justify-center">
                    <i id="play-icon" class='ph-fill ph-play text-3xl'></i>
                    <i id="stop-icon" class='ph-fill ph-stop text-3xl hidden'></i>
                </button>
            </div>

            <!-- Botão Fechar -->
            <button id="close-player-btn" class="absolute bottom-4 right-4 bg-red-600/80 backdrop-blur-sm text-white w-12 h-12 rounded-full shadow-2xl hover:bg-red-500 flex items-center justify-center z-10">
                <i class='ph-bold ph-x text-2xl'></i>
            </button>
        </div>
    </div>
    
    <!-- Elemento de áudio para reprodução -->
    <audio id="audio-player" src="https://stream.sunshine-live.de/edm/mp3-128/"></audio>

    <script>
        const workoutPhases = {
            "phase1": { title: "Fase 1: Adaptação", weeks: [1], schedule: { "Seg": "A", "Ter": "B", "Qua": "C", "Qui": "A", "Sex": "B", "Sáb": "OFF", "Dom": "OFF" }, workouts: { "A": { name: "Treino A - Puxar", exercises: [ { name: "Pulley Frente Aberto", series: "3", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Puxada Triângulo", series: "3", rept: "15 a 20", descanso: "1 Min", method: "Convencional" }, { name: "Remada Serrote", series: "3", rept: "15 a 20", descanso: "1 Min", method: "Convencional" }, { name: "Remada Baixa Triângulo", series: "3", rept: "15 a 20", descanso: "1 Min", method: "Convencional" }, { name: "Rosca Direta Barra Reta", series: "3", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Tríceps Corda", series: "3", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Rosca Martelo + Tríceps Francês (Corda)", series: "3", rept: "15 a 20", descanso: "1 Min", method: "BI-SET" } ] }, "B": { name: "Treino B - Pernas", exercises: [ { name: "Cadeira Extensora", series: "3", rept: "8 a 12", descanso: "90 seg", method: "Convencional" }, { name: "Leg Press 45", series: "3", rept: "8 a 12", descanso: "90 seg", method: "Convencional" }, { name: "Cadeira Adutora", series: "3", rept: "15 a 20", descanso: "90 seg", method: "Convencional" }, { name: "Cadeira Extensora (2)", series: "3", rept: "15 a 20", descanso: "90 seg", method: "Convencional" }, { name: "Cadeira Flexora", series: "4", rept: "8 a 12", descanso: "90 seg", method: "Convencional" }, { name: "Cadeira Abdutora", series: "3", rept: "15 a 20", descanso: "90 seg", method: "Convencional" } ] }, "C": { name: "Treino C - Empurrar", exercises: [ { name: "Supino Inclinado Máquina", series: "3", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Crucifixo Inclinado", series: "3", rept: "15 a 20", descanso: "60 seg", method: "Isometria" }, { name: "Supino Reto Máquina", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Desenvolvimento Máquina Aberto", series: "3", rept: "8 a 12", descanso: "60 seg", method: "Conv+Isometria" }, { name: "Elevação Lateral", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Convencional" }, { name: "Tríceps Paralela", series: "3", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Tríceps Corda", series: "3", rept: "15 a 20", descanso: "60 seg", method: "Convencional" } ] } } },
            "phase2": { title: "Fase 2: Aumento de Volume", weeks: [2, 3, 4, 5, 6], schedule: { "Seg": "A", "Ter": "B", "Qua": "C", "Qui": "OFF", "Sex": "D", "Sáb": "E", "Dom": "OFF" }, workouts: { "A": { name: "Treino A - Ombros", exercises: [ { name: "Desenvolvimento Máquina", series: "4", rept: "20/18/15/12", descanso: "1 Min", method: "Pirâmide Crescente" }, { name: "Elevação Lateral na Polia", series: "4", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Elevação Lateral com Halter", series: "4", rept: "15 a 20", descanso: "1 Min", method: "Drop Set 1 descida" }, { name: "Elevação Frontal na Polia", series: "3", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Elevação Frontal Barra", series: "3", rept: "15 a 20", descanso: "1 Min", method: "Convencional" }, { name: "Crucifixo Inverso Máquina", series: "3", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Pull Face", series: "3", rept: "15 a 20", descanso: "1 Min", method: "Drop Set 1 descida" } ] }, "B": { name: "Treino B - Quadríceps", exercises: [ { name: "Cadeira Extensora", series: "3", rept: "15 a 20", descanso: "90 seg", method: "Convencional" }, { name: "Leg Press 45", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Agachamento Hack", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Cadeira Adutora", series: "4", rept: "15 a 20", descanso: "90 seg", method: "Convencional" }, { name: "Cadeira Extensora", series: "4", rept: "15 a 20", descanso: "90 seg", method: "Drop Set 1 descida" }, { name: "Panturrilha em Pé Máquina", series: "6", rept: "15 a 20", descanso: "45 seg", method: "Convencional" } ] }, "C": { name: "Treino C - Costas e Bíceps", exercises: [ { name: "Puxada Frente Aberta", series: "4", rept: "20/18/15/12", descanso: "60 seg", method: "Pirâmide Crescente" }, { name: "Barra Fixa", series: "3", rept: "Falha", descanso: "60 seg", method: "Convencional" }, { name: "Remada na Máquina Articulada", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Remada Baixa Triângulo", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Drop Set 1 descida" }, { name: "Remada Pronada na Máquina", series: "3", rept: "15 a 20", descanso: "60 seg", method: "Convencional" }, { name: "Rosca Direta Barra W", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Rosca Scott na Máquina com Barra W", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Drop Set 1 descida" } ] }, "D": { name: "Treino D - Peito e Tríceps", exercises: [ { name: "Supino Inclinado Máquina", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Pirâmide Crescente" }, { name: "Crucifixo Inclinado", series: "3", rept: "15 a 20", descanso: "60 seg", method: "Convencional" }, { name: "Supino Reto Máquina", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Crucifixo Máquina Reto", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Drop Set 1 descida" }, { name: "Tríceps Paralela", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Tríceps Corda", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Drop Set 1 descida" } ] }, "E": { name: "Treino E - Posterior e Glúteo", exercises: [ { name: "Mesa Flexora", series: "3", rept: "8 a 12", descanso: "90 seg", method: "Convencional" }, { name: "Cadeira Flexora", series: "4", rept: "12 a 15", descanso: "90 seg", method: "Drop Set 1 descida" }, { name: "Stiff", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Cadeira Abdutora", series: "3", rept: "15 a 20", descanso: "90 seg", method: "Convencional" }, { name: "Elevação Pélvica com Barra", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Panturrilha em Pé Máquina", series: "5", rept: "15 a 20", descanso: "90 seg", method: "Convencional" } ] } } },
            "phase3": { title: "Fase 3: Mais Volume e Técnicas", weeks: [7, 8, 9, 10], schedule: { "Seg": "A", "Ter": "B", "Qua": "C", "Qui": "OFF", "Sex": "D", "Sáb": "E", "Dom": "OFF" }, workouts: { "A": { name: "Treino A - Ombros", exercises: [ { name: "Desenvolvimento Máquina", series: "4", rept: "20/18/15/12", descanso: "1 Min", method: "Pirâmide Crescente" }, { name: "Elevação Lateral na Polia", series: "4", rept: "8 a 12", descanso: "1 Min", method: "Rest Pause Última Série" }, { name: "Elevação Lateral com Halter", series: "4", rept: "15 a 20", descanso: "1 Min", method: "Drop Set Todas as Séries" }, { name: "Elevação Frontal na Polia", series: "4", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Elevação Frontal Barra", series: "4", rept: "15 a 20", descanso: "1 Min", method: "Rest Pause Última Série" }, { name: "Crucifixo Inverso Máquina", series: "4", rept: "8 a 12", descanso: "1 Min", method: "Convencional" }, { name: "Pull Face", series: "4", rept: "15 a 20", descanso: "1 Min", method: "Drop Set Todas as Séries" } ] }, "B": { name: "Treino B - Quadríceps", exercises: [ { name: "Cadeira Extensora", series: "4", rept: "15 a 20", descanso: "90 seg", method: "Convencional" }, { name: "Leg Press 45", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Agachamento Hack", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Agachamento Smith", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Cadeira Adutora", series: "4", rept: "15 a 20", descanso: "90 seg", method: "Convencional" }, { name: "Cadeira Extensora", series: "4", rept: "15 a 20", descanso: "90 seg", method: "Drop Set Todas as Séries" }, { name: "Panturrilha em Pé Máquina", series: "6", rept: "15 a 20", descanso: "45 seg", method: "Convencional" } ] }, "C": { name: "Treino C - Costas e Bíceps", exercises: [ { name: "Puxada Frente Aberta", series: "4", rept: "20/18/15/12", descanso: "60 seg", method: "Pirâmide Crescente" }, { name: "Barra Fixa", series: "4", rept: "Falha", descanso: "60 seg", method: "Rest Pause Última Série" }, { name: "Remada na Máquina Articulada", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Remada Baixa Triângulo", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Drop Set Todas as Séries" }, { name: "Remada Pronada na Máquina", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Convencional" }, { name: "Rosca Direta Barra W", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Rosca Scott na Máquina com Barra W", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Rest Pause Última Série" }, { name: "Rosca Spider com Barra W", series: "3", rept: "15 a 20", descanso: "60 seg", method: "Drop Set Todas as Séries" } ] }, "D": { name: "Treino D - Peito e Tríceps", exercises: [ { name: "Supino Inclinado Máquina", series: "4", rept: "20/18/15/12", descanso: "60 seg", method: "Pirâmide Crescente" }, { name: "Crucifixo Inclinado", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Convencional" }, { name: "Supino Reto Máquina", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Crucifixo Máquina Reto", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Drop Set 1 descida" }, { name: "Tríceps Francês Corda", series: "3", rept: "8 a 12", descanso: "60 seg", method: "Convencional" }, { name: "Tríceps Paralela", series: "4", rept: "8 a 12", descanso: "60 seg", method: "Rest Pause Última Série" }, { name: "Tríceps Corda", series: "4", rept: "15 a 20", descanso: "60 seg", method: "Drop Set Todas as Séries" } ] }, "E": { name: "Treino E - Posterior e Glúteo", exercises: [ { name: "Mesa Flexora", series: "4", rept: "8 a 12", descanso: "90 seg", method: "Rest Pause Última Série" }, { name: "Cadeira Flexora", series: "4", rept: "12 a 15", descanso: "90 seg", method: "Drop Set Todas as Séries" }, { name: "Stiff", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Cadeira Abdutora", series: "4", rept: "15 a 20", descanso: "90 seg", method: "Rest Pause Última Série" }, { name: "Elevação Pélvica com Barra", series: "4", rept: "20/18/15/12", descanso: "90 seg", method: "Pirâmide Crescente" }, { name: "Panturrilha em Pé Máquina", series: "5", rept: "15 a 20", descanso: "90 seg", method: "Convencional" } ] } } },
            "phase4": { title: "Fase 4: Método MAIS CINCO", weeks: [11, 12], schedule: { "Seg": "A", "Ter": "B", "Qua": "C", "Qui": "OFF", "Sex": "D", "Sáb": "E", "Dom": "OFF" }, workouts: { "A": { name: "Treino A - Ombros", exercises: [ { name: "Desenvolvimento Máquina", series: "4", rept: "20/18/15/12", descanso: "90 Seg", method: "Pirâmide + MAIS CINCO" }, { name: "Elevação Lateral Polia", series: "4", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Elevação Lateral com Halter", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Elevação Frontal na Polia", series: "4", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Elevação Frontal Barra", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Crucifixo Inverso Máquina", series: "4", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Pull Face", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" } ] }, "B": { name: "Treino B - Quadríceps", exercises: [ { name: "Cadeira Extensora", series: "4", rept: "15 a 20", descanso: "2 Min", method: "MAIS CINCO" }, { name: "Leg Press 45", series: "4", rept: "20/18/15/12", descanso: "2 Min", method: "Pirâmide + MAIS CINCO" }, { name: "Agachamento Hack", series: "4", rept: "20/18/15/12", descanso: "2 Min", method: "Pirâmide + MAIS CINCO" }, { name: "Agachamento Smith", series: "4", rept: "20/18/15/12", descanso: "2 Min", method: "Pirâmide + MAIS CINCO" }, { name: "Cadeira Adutora", series: "4", rept: "15 a 20", descanso: "2 Min", method: "MAIS CINCO" }, { name: "Cadeira Extensora", series: "4", rept: "15 a 20", descanso: "2 Min", method: "MAIS CINCO" }, { name: "Panturrilha em Pé Máquina", series: "6", rept: "15 a 20", descanso: "45 seg", method: "MAIS CINCO" } ] }, "C": { name: "Treino C - Costas e Bíceps", exercises: [ { name: "Puxada Frente Aberta", series: "4", rept: "20/18/15/12", descanso: "90 Seg", method: "Pirâmide + MAIS CINCO" }, { name: "Barra Fixa", series: "4", rept: "Falha", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Remada na Máquina Articulada", series: "4", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Remada Baixa Triângulo", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Remada Pronada na Máquina", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Rosca Direta Barra W", series: "4", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Rosca Scott na Máquina com Barra W", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Rosca Spider com Barra W", series: "3", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" } ] }, "D": { name: "Treino D - Peito e Tríceps", exercises: [ { name: "Supino Inclinado Máquina", series: "4", rept: "20/18/15/12", descanso: "90 Seg", method: "Pirâmide + MAIS CINCO" }, { name: "Crucifixo Inclinado", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Supino Reto Máquina", series: "4", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Crucifixo Máquina Reto", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Tríceps Francês Corda", series: "3", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Tríceps Paralela", series: "4", rept: "8 a 12", descanso: "90 Seg", method: "MAIS CINCO" }, { name: "Tríceps Corda", series: "4", rept: "15 a 20", descanso: "90 Seg", method: "MAIS CINCO" } ] }, "E": { name: "Treino E - Posterior e Glúteo", exercises: [ { name: "Mesa Flexora", series: "4", rept: "8 a 12", descanso: "2 Min", method: "MAIS CINCO" }, { name: "Cadeira Flexora", series: "4", rept: "12 a 15", descanso: "2 Min", method: "MAIS CINCO" }, { name: "Stiff", series: "4", rept: "20/18/15/12", descanso: "2 Min", method: "Pirâmide + MAIS CINCO" }, { name: "Cadeira Abdutora", series: "4", rept: "15 a 20", descanso: "2 Min", method: "MAIS CINCO" }, { name: "Elevação Pélvica com Barra", series: "4", rept: "20/18/15/12", descanso: "2 Min", method: "Pirâmide + MAIS CINCO" }, { name: "Panturrilha em Pé Máquina", series: "5", rept: "15 a 20", descanso: "2 Min", method: "MAIS CINCO" } ] } } }
        };

        const appState = {
            currentWeekNumber: 1,
            currentDay: 'Seg',
            highestUnlockedWeek: 1,
            highestUnlockedDayIndex: 0, 
            completionStatus: {}
        };

        const dom = {
            stepperNav: document.getElementById('stepper-nav'),
            daySelector: document.getElementById('day-selector'),
            workoutDetails: document.getElementById('workout-details'),
            workoutTitle: document.getElementById('workout-title'),
            progressBarContainer: document.getElementById('progress-bar-container'),
            phaseHeader: document.getElementById('phase-header'),
            footer: document.getElementById('footer-container'),
            completeWorkoutBtn: document.getElementById('complete-workout-btn')
        };
        
        const confettiCanvas = document.getElementById('confetti-canvas');
        const myConfetti = confetti.create(confettiCanvas, {
            resize: true,
            useWorker: true
        });

        // --- Funções Utilitárias ---
        function showCompletionMessage() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-[200] p-4';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-8 text-center border border-gray-700 shadow-2xl animate-fadeIn">
                    <h2 class="text-3xl font-bold text-orange-500 mb-4">Parabéns!</h2>
                    <p class="text-white text-lg mb-6">Você concluiu o programa de 12 semanas!</p>
                    <button id="close-modal-btn" class="bg-orange-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-orange-700">Fechar</button>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Confetes contínuos
            let confettiInterval;
            
            // Função para disparar confetes
            const fireConfetti = () => {
                myConfetti({
                    particleCount: 150,
                    spread: 90,
                    origin: { y: 0.6 },
                    colors: ['#f97316', '#fb923c', '#fed7aa', '#ffffff']
                });
            };
            
            // Dispara confetes na hora
            fireConfetti();

            // Continua disparando confetes a cada 3 segundos
            confettiInterval = setInterval(fireConfetti, 3000);
            
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                clearInterval(confettiInterval); // Para a chuva de confetes
                modal.remove();
            });
        }
        
        function resetState() {
            localStorage.removeItem('workoutProgress');
            appState.currentWeekNumber = 1;
            appState.currentDay = 'Seg';
            appState.highestUnlockedWeek = 1;
            appState.highestUnlockedDayIndex = 0;
            appState.completionStatus = {};
            console.warn("Estado foi resetado devido a dados salvos inválidos.");
        }

        // --- Gerenciamento de Estado ---
        function saveState() {
            localStorage.setItem('workoutProgress', JSON.stringify({
                highestUnlockedWeek: appState.highestUnlockedWeek,
                highestUnlockedDayIndex: appState.highestUnlockedDayIndex,
            }));
        }

        function loadState() {
            try {
                const savedStateJSON = localStorage.getItem('workoutProgress');
                if (!savedStateJSON) return;

                const savedState = JSON.parse(savedStateJSON);
                
                if (typeof savedState !== 'object' || savedState === null ||
                    typeof savedState.highestUnlockedWeek !== 'number' ||
                    typeof savedState.highestUnlockedDayIndex !== 'number') {
                    throw new Error("Estrutura de estado inválida.");
                }
                
                let week = savedState.highestUnlockedWeek;
                if (week < 1 || week > 12) {
                     throw new Error("Número da semana inválido.");
                }

                const phaseData = getPhaseDataByWeek(week);
                if (!phaseData) {
                    throw new Error(`Dados da fase não encontrados para a semana ${week}.`);
                }

                const dayKeys = Object.keys(phaseData.schedule);
                let dayIndex = savedState.highestUnlockedDayIndex;
                if (dayIndex < 0 || dayIndex >= dayKeys.length) {
                    dayIndex = 0;
                }
                
                appState.highestUnlockedWeek = week;
                appState.currentWeekNumber = week;
                appState.highestUnlockedDayIndex = dayIndex;
                appState.currentDay = dayKeys[dayIndex];

            } catch (error) {
                console.error("Falha ao carregar ou validar estado do localStorage. Resetando.", error);
                resetState();
            }
        }
        
        function getPhaseDataByWeek(weekNumber) {
            for (const phaseKey in workoutPhases) {
                const phase = workoutPhases[phaseKey];
                if (phase.weeks.includes(weekNumber)) {
                    return phase;
                }
            }
            return null;
        }

        // --- Funções de Renderização ---
        function renderStepperNav() {
            dom.stepperNav.innerHTML = '';
            const container = document.createElement('div');
            container.className = 'relative w-full px-1 md:px-2';

            const track = document.createElement('div');
            track.className = 'absolute top-1/2 -translate-y-1/2 left-0 w-full h-1 bg-gray-700 rounded-full';
            container.appendChild(track);

            const progressFill = document.createElement('div');
            const progressPercentage = appState.highestUnlockedWeek > 1 ? ((appState.highestUnlockedWeek - 1) / 11) * 100 : 0;
            progressFill.className = 'absolute top-1/2 -translate-y-1/2 left-0 h-1 bg-orange-500 rounded-full transition-all duration-500';
            progressFill.style.width = `${progressPercentage}%`;
            container.appendChild(progressFill);

            const markersContainer = document.createElement('div');
            markersContainer.className = 'relative flex justify-between items-center px-1 md:px-0';
            
            for (let i = 1; i <= 12; i++) {
                const weekNumber = i;
                const isLocked = weekNumber > appState.highestUnlockedWeek;
                
                const markerWrapper = document.createElement('div');
                markerWrapper.className = `group relative flex flex-col items-center p-0.5 md:p-2 ${isLocked ? 'cursor-not-allowed' : 'cursor-pointer'}`;
                
                if (!isLocked) {
                    markerWrapper.addEventListener('click', () => {
                        appState.currentWeekNumber = weekNumber;
                        const newPhaseData = getPhaseDataByWeek(weekNumber);
                        const dayKeys = Object.keys(newPhaseData.schedule);
                        appState.currentDay = weekNumber === appState.highestUnlockedWeek ? dayKeys[appState.highestUnlockedDayIndex] : dayKeys[0];
                        appState.completionStatus = {};
                        renderAll();
                    });
                }

                const marker = document.createElement('div');
                let markerClasses = 'w-1.5 h-1.5 md:w-3 md:h-3 rounded-full transition-all duration-300 flex items-center justify-center';
                if (weekNumber === appState.currentWeekNumber) {
                    if (weekNumber === 12) {
                        markerClasses += ' bg-white border-2 border-yellow-500 scale-150 ring-2 ring-yellow-300';
                        marker.innerHTML = `<i class='ph-fill ph-trophy text-yellow-500 text-xs md:text-sm'></i>`;
                        markerClasses += ' w-3 h-3 md:w-6 md:h-6';
                    } else {
                        markerClasses += ' bg-orange-500 border-2 border-orange-400 scale-150 current-week-marker-animation';
                    }
                } else if (weekNumber < appState.highestUnlockedWeek) {
                    markerClasses += ' bg-gray-800 border-2 border-orange-500';
                } else {
                    markerClasses += isLocked ? ' bg-gray-800 border-2 border-gray-600' : ' bg-gray-600';
                }
                if(isLocked) {
                    if(weekNumber === 12) {
                        marker.innerHTML = `<i class='ph-fill ph-trophy text-yellow-500 text-xs md:text-sm'></i>`;
                    } else {
                        marker.innerHTML = `<i class='ph-fill ph-lock-key text-gray-500 text-xs md:text-sm'></i>`;
                    }
                    markerClasses += ' w-3 h-3 md:w-6 md:h-6';
                }
                marker.className = markerClasses;
                
                const tooltip = document.createElement('span');
                tooltip.className = 'step-tooltip absolute bottom-full mb-2 px-2 py-1 text-xs font-semibold text-white bg-gray-700 rounded-md shadow-lg whitespace-nowrap';
                tooltip.textContent = `Semana ${weekNumber}`;
                
                markerWrapper.appendChild(tooltip);
                markerWrapper.appendChild(marker);
                markersContainer.appendChild(markerWrapper);
            }
            
            container.appendChild(markersContainer);
            dom.stepperNav.appendChild(container);
        }

        function renderPhaseHeader() {
            const phaseData = getPhaseDataByWeek(appState.currentWeekNumber);
            if (!phaseData) return;
            dom.phaseHeader.innerHTML = `
                <h2 class="text-3xl md:text-4xl font-black text-orange-400 tracking-tight">${phaseData.title}</h2>
                <p class="text-lg text-gray-400 font-semibold mt-1">Semana ${appState.currentWeekNumber} de 12</p>
            `;
        }

        function renderDaySelector() {
            const phaseData = getPhaseDataByWeek(appState.currentWeekNumber);
            const dayKeys = Object.keys(phaseData.schedule);
            dom.daySelector.innerHTML = '';

            dayKeys.forEach((day, index) => {
                const isLocked = appState.currentWeekNumber === appState.highestUnlockedWeek && index > appState.highestUnlockedDayIndex;
                const workoutLetter = phaseData.schedule[day];
                const button = document.createElement('button');
                button.textContent = day;
                let buttonClasses = `px-2 md:px-3 py-1.5 text-xs md:text-sm rounded-md font-semibold transition-colors duration-200 flex-1 text-center min-w-0 `;

                if (isLocked || workoutLetter === 'OFF') {
                    buttonClasses += 'bg-gray-800 text-gray-500 cursor-not-allowed';
                    button.disabled = true;
                } else if (appState.currentDay === day) {
                    buttonClasses += 'bg-orange-600 text-white';
                } else {
                    buttonClasses += 'bg-gray-700 text-gray-400 hover:bg-gray-600';
                }

                button.className = buttonClasses;

                if (!isLocked && workoutLetter !== 'OFF') {
                    button.addEventListener('click', () => {
                        appState.currentDay = day;
                        appState.completionStatus = {};
                        renderWorkout();
                        renderDaySelector();
                    });
                }
                dom.daySelector.appendChild(button);
            });
        }

        function renderWorkout() {
            const phaseData = getPhaseDataByWeek(appState.currentWeekNumber);
            if (!phaseData) return; 
            const workoutLetter = phaseData.schedule[appState.currentDay];
            dom.workoutDetails.innerHTML = '';
            dom.workoutTitle.innerHTML = '';
            dom.progressBarContainer.innerHTML = '';
            dom.footer.style.display = 'none';

            if (workoutLetter === 'OFF' || !phaseData.workouts[workoutLetter]) {
                dom.workoutTitle.innerHTML = `<h2 class="text-2xl font-bold text-gray-400">Dia de Descanso</h2>`;
                return;
            }
            
            dom.footer.style.display = 'block';

            const workout = phaseData.workouts[workoutLetter];
            dom.workoutTitle.innerHTML = `<h2 class="text-3xl font-bold text-white">${workout.name}</h2>`;
            
            const totalExercises = workout.exercises.length;
            const completedExercises = Object.values(appState.completionStatus).filter(Boolean).length;
            const progress = totalExercises > 0 ? (completedExercises / totalExercises) * 100 : 0;
            
            dom.completeWorkoutBtn.disabled = completedExercises < totalExercises;

            dom.progressBarContainer.innerHTML = `
                <div class="flex justify-between items-center mb-1 text-sm font-semibold">
                    <span class="text-gray-400">Progresso do Treino</span>
                    <span class="text-white">${completedExercises} / ${totalExercises}</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2.5 overflow-hidden">
                    <div class="bg-orange-500 h-2.5 rounded-full transition-all duration-500 progress-bar-striped" style="width: ${progress}%"></div>
                </div>
            `;

            workout.exercises.forEach((exercise, index) => {
                const isCompleted = appState.completionStatus[index];
                const card = document.createElement('div');
                card.className = `bg-gray-800 rounded-xl shadow-lg border border-gray-700 transition-all duration-300 flex flex-col ${isCompleted ? 'exercise-completed' : ''}`;
                
                let imageUrl;
                if (exercise.name === 'Elevação Lateral na Polia') {
                    imageUrl = 'imagens/Elevação Lateral na Polia.gif';
                } else if (exercise.name === 'Pulley Frente Aberto') {
                    imageUrl = 'imagens/Pulley Frente Aberto.gif';
                } else if (exercise.name === 'Puxada Triângulo') {
                    imageUrl = 'imagens/Puxada Triângulo.gif';
                } else if (exercise.name === 'Remada Serrote') {
                    imageUrl = 'imagens/Remada Serrote.gif';
                } else if (exercise.name === 'Remada Baixa Triângulo') {
                    imageUrl = 'imagens/Remada Baixa Triângulo.gif';
                } else if (exercise.name === 'Rosca Direta Barra Reta') {
                    imageUrl = 'imagens/Rosca Direta Barra Reta.gif';
                } else if (exercise.name === 'Tríceps Corda') {
                    imageUrl = 'imagens/Tríceps Corda.gif';
                } else if (exercise.name === 'Rosca Martelo + Tríceps Francês (Corda)') {
                    imageUrl = 'imagens/Rosca Martelo + Tríceps Francês (Corda).gif';
                } else if (exercise.name === 'Desenvolvimento Máquina') {
                    imageUrl = 'imagens/Desenvolvimento Máquina.gif';
                } else if (exercise.name === 'Cadeira Extensora') {
                    imageUrl = 'imagens/Cadeira Extensora.gif';
                } else if (exercise.name === 'Leg Press 45') {
                    imageUrl = 'imagens/Leg Press 45.gif';
                } else if (exercise.name === 'Cadeira Adutora') {
                    imageUrl = 'imagens/Cadeira Adutora.gif';
                } else if (exercise.name === 'Cadeira Extensora (2)') {
                    imageUrl = 'imagens/Cadeira Extensora (2).gif';
                } else if (exercise.name === 'Cadeira Flexora') {
                    imageUrl = 'imagens/Cadeira Flexora.gif';
                } else if (exercise.name === 'Cadeira Abdutora') {
                    imageUrl = 'imagens/Cadeira Abdutora.gif';
                } else if (exercise.name === 'Supino Inclinado Máquina') {
                    imageUrl = 'imagens/Supino Inclinado Máquina.gif';
                } else if (exercise.name === 'Crucifixo Inclinado') {
                    imageUrl = 'imagens/Crucifixo Inclinado.gif';
                } else if (exercise.name === 'Supino Reto Máquina') {
                    imageUrl = 'imagens/Supino Reto Máquina.gif';
                } else if (exercise.name === 'Desenvolvimento Máquina Aberto') {
                    imageUrl = 'imagens/Desenvolvimento Máquina Aberto.gif';
                } else if (exercise.name === 'Elevação Lateral') {
                    imageUrl = 'imagens/Elevação Lateral.gif';
                } else if (exercise.name === 'Tríceps Paralela') {
                    imageUrl = 'imagens/Tríceps Paralela.gif';
                } else if (exercise.name === 'Elevação Lateral com Halter') {
                    imageUrl = 'imagens/Elevação Lateral com Halter.gif';
                } else if (exercise.name === 'Elevação Frontal na Polia') {
                    imageUrl = 'imagens/Elevação Frontal na Polia.gif';
                } else if (exercise.name === 'Elevação Frontal Barra') {
                    imageUrl = 'imagens/Elevação Frontal Barra.gif';
                } else if (exercise.name === 'Crucifixo Inverso Máquina') { 
                    imageUrl = 'imagens/Crucifixo Inverso Máquina.gif';
                } else if (exercise.name === 'Pull Face') {
                    imageUrl = 'imagens/Pull Face.gif';
                } else if (exercise.name === 'Puxada Frente Aberta') {
                    imageUrl = 'imagens/Puxada Frente Aberta.gif';
                } else if (exercise.name === 'Barra Fixa') {
                    imageUrl = 'imagens/Barra Fixa.gif';
                } else if (exercise.name === 'Remada na Máquina Articulada') {
                    imageUrl = 'imagens/Remada na Máquina Articulada.gif';
                } else if (exercise.name === 'Remada Pronada na Máquina') {
                    imageUrl = 'imagens/Remada Pronada na Máquina.gif';
                } else if (exercise.name === 'Rosca Direta Barra W') {
                    imageUrl = 'imagens/Rosca Direta Barra W.gif';
                } else if (exercise.name === 'Rosca Scott na Máquina com Barra W') {
                    imageUrl = 'imagens/Rosca Scott na Máquina com Barra W.gif';
                } else if (exercise.name === 'Rosca Spider com Barra W') {
                    imageUrl = 'imagens/Rosca Spider com Barra W.gif';
                } else if (exercise.name === 'Tríceps Francês Corda') {
                    imageUrl = 'imagens/Tríceps Francês Corda.gif';
                } else if (exercise.name === 'Mesa Flexora') {
                    imageUrl = 'imagens/Mesa Flexora.gif';
                } else if (exercise.name === 'Stiff') {
                    imageUrl = 'imagens/Stiff.gif';
                } else if (exercise.name === 'Elevação Pélvica com Barra') {
                    imageUrl = 'imagens/Elevação Pélvica com Barra.gif';
                } else if (exercise.name === 'Panturrilha em Pé Máquina') {
                    imageUrl = 'imagens/Panturrilha em Pé Máquina.gif';
                } else if (exercise.name === 'Agachamento Hack') {
                    imageUrl = 'imagens/Agachamento Hack.gif';
                } else if (exercise.name === 'Crucifixo Máquina Reto') {
                    imageUrl = 'imagens/Crucifixo Máquina Reto.gif';
                } else if (exercise.name === 'Agachamento Smith') {
                    imageUrl = 'imagens/Agachamento Smith.gif';
                } else if (exercise.name === 'Elevação Lateral Polia') {
                    imageUrl = 'imagens/Elevação Lateral Polia.gif';
                } else {
                    imageUrl = `https://placehold.co/100x100/1f2937/FFFFFF?text=${encodeURIComponent(exercise.name.split(' ')[0])}&font=inter`;
                }

                card.innerHTML = `
                    <div class="flex-grow p-5">
                        <div class="flex flex-col items-center w-full">
                            <img src="${imageUrl}" alt="Ilustração do exercício" class="w-64 h-64 md:w-72 md:h-72 object-cover rounded-xl mb-6 shadow-xl border-4 border-orange-500/20">
                            <h3 class="text-2xl font-bold text-white text-center mb-6">${exercise.name}</h3>

                            <div class="w-full grid grid-cols-2 gap-3 text-center">
                                <div class="bg-gray-900/50 p-3 rounded-lg">
                                    <span class="text-xs uppercase text-gray-400 font-semibold tracking-wider">Séries</span>
                                    <p class="font-bold text-lg text-white">${exercise.series}</p>
                                </div>
                                <div class="bg-gray-900/50 p-3 rounded-lg">
                                    <span class="text-xs uppercase text-gray-400 font-semibold tracking-wider">Reps</span>
                                    <p class="font-bold text-lg text-white">${exercise.rept}</p>
                                </div>
                                <div class="bg-gray-900/50 p-3 rounded-lg">
                                    <span class="text-xs uppercase text-gray-400 font-semibold tracking-wider">Descanso</span>
                                    <p class="font-bold text-lg text-white">${exercise.descanso}</p>
                                </div>
                                <div class="bg-orange-600/20 text-orange-400 p-3 rounded-lg border border-orange-500/30">
                                    <span class="text-xs uppercase font-semibold tracking-wider">Método</span>
                                    <p class="font-bold text-lg">${exercise.method}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-900/50 rounded-b-xl mt-auto">
                        <div class="completion-toggle-wrapper flex items-center justify-center w-full cursor-pointer rounded-lg p-2 transition-colors duration-300 hover:bg-gray-700/50" data-index="${index}">
                            <div class="animated-check-container ${isCompleted ? 'completed' : ''}">
                                <svg class="animated-check-svg" viewBox="0 0 24 24">
                                    <circle class="animated-check-circle" cx="12" cy="12" r="10"/>
                                    <path class="animated-check-path" d="M7 13l3 3 7-7"/>
                                </svg>
                            </div>
                            <span class="ml-3 font-bold text-lg transition-colors duration-300 ${isCompleted ? 'text-green-400' : 'text-gray-300'}">${isCompleted ? 'Concluído!' : 'Marcar como Concluído'}</span>
                        </div>
                    </div>
                `;

                card.querySelector('.completion-toggle-wrapper').addEventListener('click', () => {
                    appState.completionStatus[index] = !appState.completionStatus[index];
                    renderWorkout();
                });
                
                dom.workoutDetails.appendChild(card);
            });
        }
        
        // --- Manipuladores de Eventos e Inicialização ---
        function handleCompleteWorkout() {
            myConfetti({
                particleCount: 150,
                spread: 90,
                origin: { y: 0.6 },
                colors: ['#f97316', '#fb923c', '#fed7aa', '#ffffff']
            });

            const phaseData = getPhaseDataByWeek(appState.currentWeekNumber);
            const dayKeys = Object.keys(phaseData.schedule);
            const currentDayIndex = dayKeys.indexOf(appState.currentDay);

            let nextDayIndex = currentDayIndex + 1;
            while(nextDayIndex < dayKeys.length && phaseData.schedule[dayKeys[nextDayIndex]] === 'OFF') {
                nextDayIndex++;
            }
            
            let isLastTrainingDay = !dayKeys.slice(currentDayIndex + 1).some(day => phaseData.schedule[day] !== 'OFF');

            if (isLastTrainingDay) {
                if (appState.highestUnlockedWeek < 12) {
                    appState.highestUnlockedWeek++;
                    appState.highestUnlockedDayIndex = 0;
                    appState.currentWeekNumber = appState.highestUnlockedWeek;
                    const nextPhaseData = getPhaseDataByWeek(appState.currentWeekNumber);
                    appState.currentDay = Object.keys(nextPhaseData.schedule)[0];
                } else {
                    showCompletionMessage();
                }
            } else {
                 appState.highestUnlockedDayIndex = nextDayIndex;
                 appState.currentDay = dayKeys[nextDayIndex];
            }

            appState.completionStatus = {};
            saveState();
            
            setTimeout(() => {
                renderAll();
                window.scrollTo(0, 0);
            }, 300);
        }
        
        function renderAll() {
            renderStepperNav();
            renderPhaseHeader();
            renderDaySelector();
            renderWorkout();
        }
        
        dom.completeWorkoutBtn.addEventListener('click', handleCompleteWorkout);

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializa o app de treinos
            loadState();
            renderAll();
            
            // --- LÓGICA DO PLAYER ---
            const mainContent = document.getElementById('main-content');
            const openPlayerBtn = document.getElementById('open-player-btn');
            const closePlayerBtn = document.getElementById('close-player-btn');
            const playerModal = document.getElementById('player-modal');
            const playerCard = document.getElementById('player-card');
            const audio = document.getElementById('audio-player');
            
            const playPauseBtn = document.getElementById('play-pause-btn');
            const playIcon = document.getElementById('play-icon');
            const stopIcon = document.getElementById('stop-icon');

            // Lógica do Modal
            const openModal = () => {
                playerModal.classList.remove('invisible', 'opacity-0');
                playerCard.classList.remove('scale-95');
                mainContent.classList.add('blur-sm', 'scale-105');
            };

            const closeModal = () => {
                playerModal.classList.add('invisible', 'opacity-0');
                playerCard.classList.add('scale-95');
                mainContent.classList.remove('blur-sm', 'scale-105');
            };

            closePlayerBtn.addEventListener('click', closeModal);
            playerModal.addEventListener('click', (e) => {
                if (e.target === playerModal) {
                    closeModal();
                }
            });

            // --- LÓGICA DE ARRASTAR E SOLTAR O BOTÃO DE MÚSICA ---
            let isDragging = false;
            let hasDragged = false;
            let startX, startY;
            let initialLeft, initialTop;

            function dragStart(e) {
                if (e.type === 'touchstart') {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                } else {
                    // Previne o comportamento padrão do mouse (ex: arrastar imagem)
                    e.preventDefault();
                    startX = e.clientX;
                    startY = e.clientY;
                }
                
                const rect = openPlayerBtn.getBoundingClientRect();
                initialLeft = rect.left;
                initialTop = rect.top;
                
                isDragging = true;
                hasDragged = false;
                
                openPlayerBtn.style.transition = 'none';

                window.addEventListener('mousemove', dragging);
                window.addEventListener('mouseup', dragEnd);
                window.addEventListener('touchmove', dragging, { passive: false });
                window.addEventListener('touchend', dragEnd);
            }

            function dragging(e) {
                if (!isDragging) return;
                
                // Previne o scroll da página no mobile
                if (e.type === 'touchmove') {
                    e.preventDefault();
                }

                let currentX, currentY;
                if (e.type === 'touchmove') {
                    currentX = e.touches[0].clientX;
                    currentY = e.touches[0].clientY;
                } else {
                    currentX = e.clientX;
                    currentY = e.clientY;
                }
                
                const dx = currentX - startX;
                const dy = currentY - startY;

                if (!hasDragged && (Math.abs(dx) > 5 || Math.abs(dy) > 5)) {
                    hasDragged = true;
                    if (openPlayerBtn.classList.contains('top-1/2')) {
                        openPlayerBtn.classList.remove('top-1/2', 'right-0', '-translate-y-1/2', 'mr-4', 'md:mr-6');
                        openPlayerBtn.style.top = `${initialTop}px`;
                        openPlayerBtn.style.left = `${initialLeft}px`;
                    }
                }
                
                if (hasDragged) {
                    openPlayerBtn.style.top = `${initialTop + dy}px`;
                    openPlayerBtn.style.left = `${initialLeft + dx}px`;
                }
            }

            function dragEnd() {
                if (!isDragging) return;
                isDragging = false;
                
                window.removeEventListener('mousemove', dragging);
                window.removeEventListener('mouseup', dragEnd);
                window.removeEventListener('touchmove', dragging);
                window.removeEventListener('touchend', dragEnd);
                
                if (!hasDragged) {
                    openModal();
                    return;
                }
                
                openPlayerBtn.style.transition = 'top 0.3s ease-out, left 0.3s ease-out';

                const btnRect = openPlayerBtn.getBoundingClientRect();
                const winWidth = window.innerWidth;
                const winHeight = window.innerHeight;
                const margin = 24;

                const centerX = btnRect.left + btnRect.width / 2;
                
                // Determine horizontal snap position (left or right)
                const finalLeft = (centerX < winWidth / 2) 
                    ? margin 
                    : winWidth - btnRect.width - margin;

                // Define the vertical snap points based on the final *top* position of the button
                const snapPointsY = [
                    margin, // Top
                    (winHeight / 2) - (btnRect.height / 2), // Middle
                    winHeight - btnRect.height - margin // Bottom
                ];

                // Find the closest vertical snap point to the button's current top position
                let finalTop = snapPointsY.reduce((closest, current) => {
                    return (Math.abs(current - btnRect.top) < Math.abs(closest - btnRect.top) ? current : closest);
                });
                
                openPlayerBtn.style.top = `${finalTop}px`;
                openPlayerBtn.style.left = `${finalLeft}px`;
                openPlayerBtn.style.transform = 'none';
            }

            openPlayerBtn.addEventListener('mousedown', dragStart);
            openPlayerBtn.addEventListener('touchstart', dragStart);

            // Lógica do Player
            let isPlaying = false;

            const togglePlay = () => {
                if (isPlaying) {
                    audio.pause(); // Pausa o stream
                } else {
                    // Força o reload do stream para reconectar
                    audio.load();
                    audio.play().catch(e => console.error("Erro ao tocar áudio:", e));
                }
            };
            
            const updatePlayPauseIcon = () => {
                playIcon.classList.toggle('hidden', isPlaying);
                stopIcon.classList.toggle('hidden', !isPlaying);
            };

            // Event Listeners para o Player
            playPauseBtn.addEventListener('click', togglePlay);
            audio.addEventListener('play', () => { isPlaying = true; updatePlayPauseIcon(); });
            audio.addEventListener('pause', () => { isPlaying = false; updatePlayPauseIcon(); });

            // Define volume inicial para 100% (máximo permitido pelo navegador)
            audio.volume = 1.0;
        });
    </script>
</body>
</html>
